<script>
    const REFRESH_INTERVAL = 10000;
    let dynmapLink = './dynmap';

    startClick = () => {
        console.log('WakeUp');
        $.post('./wakeup', {})
            .done((sucess) => { 
                console.log('WakeUp Sucess', sucess); 
                if($('#server-status').text() === 'üõë ÏÑúÎ≤Ñ Í∫ºÏßê üõë' || $('#server-status').text() === 'üí§ Sleeping üí§'){
                    $('#server-status').text(`üüß ÏãúÏûë Ï§ë üüß`); 
                    $('#wakeup-button').text('...5~7Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§...'); 
                } else if ($('#server-status').text().includes('Running')) {
                    $('#server-status').text(`üüß Ï¢ÖÎ£å Ï§ë üüß`); 
                    $('#wakeup-button').text('...1~2Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§...'); 
                }
            })
            .fail((error) => { console.log('WakeUp Error', error); })
    };

    restartClick = () => {
        console.log('Restart');
        $.post('./restart', {})
            .done((sucess) => { 
                console.log('Restart Sucess', sucess); 
                $('#server-status').text(`üüß Ïû¨ÏãúÏûë Ï§ë üüß`);
                $('#restart-button').text('...8~10Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§...');
            })
            .fail((error) => { console.log('Restart Error', error); })
    };

    shutdownClick = () => {
        console.log('Shutdown');
        $.post('./shutdown', {})
            .done((sucess) => { 
                console.log('Shutdown Sucess', sucess); 
                $('#server-status').text(`üüß Ï¢ÖÎ£å Ï§ë üüß`);
                $('#shutdown-button').text('...1~2Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§...');
            })
            .fail((error) => { console.log('Shutdown Error', error); })
    };

    getTexts = (status) => {
        let emoji = 'üü•'
        let buttonText = 'ÏÑúÎ≤Ñ ÏºúÍ∏∞';
        switch (status) {
            case 'Running':
                emoji = 'üü©'
                buttonText = 'ÏÑúÎ≤Ñ ÎÅÑÍ∏∞'
                break;
            case 'Sleeping':
                emoji = 'üí§'
                break;
            case 'Starting':
                emoji = 'üüß'
                buttonText = '...5~7Î∂Ñ ÏÜåÏöîÎê©ÎãàÎã§...'
                break;
        }
        return { emoji, buttonText };
    };

    getStatus = () => {
        $.get('./status')
            .done(
                (value) => {
                    console.log(`${new Date().toISOString()} - getStatus`, value);

                    const { status, dynmap, settings } = value;
                    const { emoji, buttonText } = getTexts(status)
                    $('#server-status').text(`${emoji} ${status} ${emoji}`);
                    
                    const displayWakeBtn = (settings.preventStop && status === "Running") ? 'none' : 'unset';
                    $('#wakeup-button').text(buttonText);
                    $('#wakeup-button').css('display', displayWakeBtn);

                    //const displayRestart = (settings.webAllowRestart && status === "Running") ? 'unset' : 'none';
                    //$('#restart-button').css('display', displayRestart);
                    const displayShutdown = (status === "Starting") ? 'unset' : 'none';
                    $('#shutdown-button').css('display', displayShutdown);

                    const displayDynmap = dynmap ? 'unset' : 'none';
                    $('#dynmap-button').css('display', displayDynmap);
                    dynmapLink = typeof dynmap === 'string' && dynmap.includes("http") ? dynmap : './dynmap';
                })
            .fail(
                (error) => {
                    $('#server-status').text('üõë ÏÑúÎ≤Ñ Í∫ºÏßê üõë');
                })
    };


    homeLoaded = () => {
        console.log("HomeLoaded");

        getStatus();

        setTimeout(() => {
            $('#dynmap-button').click(() => {
                window.open(dynmapLink, '_blank')
            });
        }, 50);

        setTimeout(() => {
            setInterval(getStatus, REFRESH_INTERVAL);
        }, REFRESH_INTERVAL);
    }
    homeLoaded();
</script>


<div class="homeContainer">
    <div>
        <img alt="FavIcon" class="imageContainer" src={{favIcon}}>
    </div>
    <div class="homeCenter">
        <div>
            <div>{{{ motd }}}</div>
            <div id="server-status" style="text-align: center;">üõë ÏÑúÎ≤Ñ Í∫ºÏßê üõë</div>
        </div>
    </div>
    <div class="buttonContainer">
        <button id="wakeup-button" class="button secondary actionButton" onclick=" startClick() ">
            Wake Up
        </button>
        {{!-- <button id="restart-button" class="button secondary actionButton" style="display: none;" onclick=" restartClick() ">
            Restart
        </button> --}}
        <button id="shutdown-button" class="button secondary actionButton" style="display: none;" onclick=" shutdownClick() ">
            Shutdown
        </button>
        <button id="dynmap-button" class="button secondary actionButton" target="_blank" style="display: none;">
            Dynmap
        </button>
    </div>
</div>